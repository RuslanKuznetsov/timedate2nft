<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT –í—Ä–µ–º–µ–Ω–∏ - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ 416</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@latest/dist/tonweb.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #modal, #modal-content-div {
            transition: all 0.3s ease-in-out;
        }
        #wallet-connect-button {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
        }
        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
            margin-bottom: 24px;
        }
        .balance-amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 8px 0;
        }
        .transaction-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .loading-balance {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .debug-info {
            background: #1f2937;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 relative">

    <div id="wallet-connect-button"></div>

    <div class="w-full max-w-md mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white">NFT –í—Ä–µ–º–µ–Ω–∏</h1>
                <p class="text-gray-400 mt-2">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ 416 - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload</p>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—Ä–∞ payload -->
            <div class="bg-gray-700 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-2">üìè –†–∞–∑–º–µ—Ä payload</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span>–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</span>
                        <span id="payload-status" class="text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>–†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö:</span>
                        <span id="payload-size" class="text-gray-400">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>–õ–∏–º–∏—Ç TON:</span>
                        <span class="text-green-400">65535 –±–∞–π—Ç</span>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ -->
            <div id="wallet-balance-card" class="balance-card hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm opacity-90">–ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞</p>
                        <div id="balance-amount" class="balance-amount loading-balance">
                            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                        <p class="text-xs opacity-75" id="balance-currency">TON Testnet</p>
                    </div>
                    <div class="text-right">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <span class="text-2xl">üíé</span>
                        </div>
                    </div>
                </div>
                <div id="wallet-info" class="mt-3 text-xs opacity-75">
                    <span id="wallet-address-short">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫</span>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
            <div id="diagnostic-status" class="bg-gray-700 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-2">üîß –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span>API –∫–ª—é—á:</span>
                        <span class="text-green-400">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Blockchain –≤—Ä–µ–º—è:</span>
                        <span id="blockchain-result" class="text-yellow-400">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</span>
                        <span id="connection-result" class="text-gray-400">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="date-picker" class="block text-sm font-medium text-gray-300 mb-1">–î–∞—Ç–∞</label>
                    <input type="date" id="date-picker" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="time-picker" class="block text-sm font-medium text-gray-300 mb-1">–í—Ä–µ–º—è</label>
                    <input type="time" id="time-picker" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <p id="error-message" class="text-red-400 text-sm text-center hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.</p>
            </div>

            <div id="transaction-status" class="hidden transaction-status">
                <div id="status-text"></div>
                <div id="status-details" class="text-xs mt-2 opacity-80"></div>
            </div>

            <div class="mt-8">
                <button id="mint-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg disabled:opacity-60 disabled:cursor-not-allowed">
                    –°–æ–∑–¥–∞—Ç—å NFT –≤ Testnet
                </button>
                
                <div class="flex gap-2 mt-4">
                    <button id="refresh-balance" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                    </button>
                    <button id="test-payload" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm">
                        üß™ –¢–µ—Å—Ç payload
                    </button>
                </div>
            </div>

            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div id="debug-info" class="debug-info hidden">
                <div id="debug-content"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="modal-content-div" class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center scale-95">
            <p id="modal-text" class="text-lg"></p>
            <button id="modal-close-button" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                OK
            </button>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let tonConnectUI;
        let tonweb;
        let reliableBlockchainTime = null;
        let walletBalance = null;
        let debugLogs = [];

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const mintButton = document.getElementById('mint-button');
        const datePicker = document.getElementById('date-picker');
        const timePicker = document.getElementById('time-picker');
        const errorMessage = document.getElementById('error-message');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content-div');
        const modalText = document.getElementById('modal-text');
        const modalCloseButton = document.getElementById('modal-close-button');
        const transactionStatus = document.getElementById('transaction-status');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –±–∞–ª–∞–Ω—Å–∞
        const walletBalanceCard = document.getElementById('wallet-balance-card');
        const balanceAmount = document.getElementById('balance-amount');
        const walletAddressShort = document.getElementById('wallet-address-short');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã payload
        const payloadStatus = document.getElementById('payload-status');
        const payloadSize = document.getElementById('payload-size');
        const debugInfo = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');
        
        // –°—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç—ã
        const connectionResult = document.getElementById('connection-result');
        const blockchainResult = document.getElementById('blockchain-result');

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å API –∫–ª—é—á–æ–º
        const API_KEY = 'dafd0e534ea822bfdd6211c330e05f93c99a35f3d1d7e185fa0b56682ef01363';
        const NFT_COLLECTION_ADDRESS = 'EQD4QY8soH6j6O-x-bK30e-Y_p8n_e-rI2vB8l-s6asBfL0W';
        const NFT_MINT_AMOUNT = '500000000'; // 0.12 TON - —É–≤–µ–ª–∏—á–µ–Ω–∞ —Å—É–º–º–∞ –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–º–∏—Å—Å–∏–π
        const MANIFEST_URL = 'https://ruslankuznetsov.github.io/timedate2nft/tonconnect-manifest.json';

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–õ–ê–î–ö–ò ---

        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLogs.push(logEntry);
            
            if (debugInfo.classList.contains('hidden')) {
                debugInfo.classList.remove('hidden');
            }
            
            debugContent.innerHTML = debugLogs.map(log => 
                `<div class="${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-300'}">${log}</div>`
            ).join('');
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // --- –§–£–ù–ö–¶–ò–ò UI ---

        function showModal(message) {
            modalText.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function showTransactionStatus(status, text, details = '') {
            transactionStatus.classList.remove('hidden', 'status-pending', 'status-success', 'status-error');
            transactionStatus.classList.add(`status-${status}`);
            statusText.textContent = text;
            statusDetails.textContent = details;
        }

        function hideTransactionStatus() {
            transactionStatus.classList.add('hidden');
        }

        // --- –§–£–ù–ö–¶–ò–ò –ë–ê–õ–ê–ù–°–ê ---

        async function getWalletBalance(address) {
            try {
                addDebugLog('–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—à–µ–ª—å–∫–∞...');
                const balance = await tonweb.getBalance(address);
                const balanceInTon = TonWeb.utils.fromNano(balance);
                addDebugLog(`–ë–∞–ª–∞–Ω—Å: ${balanceInTon} TON`, 'success');
                return balanceInTon;
            } catch (error) {
                addDebugLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ${error.message}`, 'error');
                return null;
            }
        }

        function displayBalance(balance, address) {
            if (balance !== null) {
                const formattedBalance = parseFloat(balance).toFixed(4);
                balanceAmount.textContent = `${formattedBalance} TON`;
                balanceAmount.classList.remove('loading-balance');
                
                if (parseFloat(balance) < 0.12) {
                    balanceAmount.style.color = '#ef4444';
                } else {
                    balanceAmount.style.color = 'white';
                }
                
                const shortAddress = `${address.slice(0, 6)}...${address.slice(-6)}`;
                walletAddressShort.textContent = shortAddress;
                walletBalanceCard.classList.remove('hidden');
            } else {
                balanceAmount.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                balanceAmount.classList.remove('loading-balance');
            }
        }

        async function updateWalletBalance() {
            if (!tonConnectUI.connected) {
                walletBalanceCard.classList.add('hidden');
                return;
            }

            const walletAddress = tonConnectUI.wallet.account.address;
            balanceAmount.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            balanceAmount.classList.add('loading-balance');
            
            const balance = await getWalletBalance(walletAddress);
            walletBalance = balance;
            displayBalance(balance, walletAddress);
        }

        // --- –§–£–ù–ö–¶–ò–ò –°–û–ó–î–ê–ù–ò–Ø –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ì–û PAYLOAD ---

        function createOptimizedNFTPayload(ownerAddress, metadataUrl) {
            try {
                addDebugLog('–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ NFT payload...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Å—Ö–µ–º—É –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const queryId = Date.now(); // –ü—Ä–æ—Å—Ç–æ–π timestamp –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ ID
                
                const body = new tonweb.boc.Cell();
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è NFT mint
                body.bits.writeUint(1, 32); // op code –¥–ª—è mint
                body.bits.writeUint(queryId, 64); // query_id (64 bits)
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è NFT item message
                const nftItemMessage = new tonweb.boc.Cell();
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
                nftItemMessage.bits.writeAddress(new TonWeb.utils.Address(ownerAddress)); // –ê–¥—Ä–µ—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞
                
                // –°–æ–∑–¥–∞–µ–º content cell —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const itemContent = new tonweb.boc.Cell();
                itemContent.bits.writeUint(0, 8); // content layout (off-chain)
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º URL –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (–±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
                const urlBytes = new TextEncoder().encode(metadataUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä URL
                if (urlBytes.length > 100) { // –õ–∏–º–∏—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    throw new Error(`URL —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π: ${urlBytes.length} –±–∞–π—Ç (–ª–∏–º–∏—Ç: 100)`);
                }
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º URL –ø–æ–±–∞–π—Ç–æ–≤–æ
                for (let i = 0; i < urlBytes.length; i++) {
                    itemContent.bits.writeUint(urlBytes[i], 8);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º content –∫–∞–∫ —Å—Å—ã–ª–∫—É
                nftItemMessage.refs.push(itemContent);
                
                // –î–æ–±–∞–≤–ª—è–µ–º NFT item message –∫–∞–∫ —Å—Å—ã–ª–∫—É –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É body
                body.refs.push(nftItemMessage);
                
                addDebugLog('Payload —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                return body;
                
            } catch (error) {
                addDebugLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è payload: ${error.message}`, 'error');
                throw error;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ payload
        async function testPayloadSize() {
            if (!tonConnectUI.connected) {
                showModal('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è payload');
                return;
            }

            try {
                payloadStatus.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                payloadStatus.className = 'text-yellow-400';
                
                addDebugLog('=== –¢–ï–°–¢ –†–ê–ó–ú–ï–†–ê PAYLOAD ===');
                
                const ownerAddress = tonConnectUI.wallet.account.address;
                const metadataUrl = "https://ruslankuznetsov.github.io/timedate2nft/sample-metadata.json";
                
                // –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload
                const body = createOptimizedNFTPayload(ownerAddress, metadataUrl);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ BoC –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                const bocBytes = await body.toBoc();
                const sizeInBytes = bocBytes.length;
                
                addDebugLog(`–†–∞–∑–º–µ—Ä payload: ${sizeInBytes} –±–∞–π—Ç`);
                addDebugLog(`–õ–∏–º–∏—Ç TON: 65535 –±–∞–π—Ç`);
                addDebugLog(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${((sizeInBytes / 65535) * 100).toFixed(2)}%`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                payloadSize.textContent = `${sizeInBytes} –±–∞–π—Ç`;
                
                if (sizeInBytes > 65535) {
                    payloadStatus.textContent = '‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç';
                    payloadStatus.className = 'text-red-400';
                    addDebugLog('–û–®–ò–ë–ö–ê: –†–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç TON!', 'error');
                } else if (sizeInBytes > 50000) {
                    payloadStatus.textContent = '‚ö†Ô∏è –ë–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É';
                    payloadStatus.className = 'text-yellow-400';
                    addDebugLog('–í–ù–ò–ú–ê–ù–ò–ï: –†–∞–∑–º–µ—Ä –±–ª–∏–∑–æ–∫ –∫ –ª–∏–º–∏—Ç—É', 'error');
                } else {
                    payloadStatus.textContent = '‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π';
                    payloadStatus.className = 'text-green-400';
                    addDebugLog('–†–∞–∑–º–µ—Ä –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã', 'success');
                }
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å base64 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
                const payloadBase64 = TonWeb.utils.bytesToBase64(bocBytes);
                addDebugLog(`Base64 –¥–ª–∏–Ω–∞: ${payloadBase64.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                
                showTransactionStatus('success', 'Payload –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω', 
                    `–†–∞–∑–º–µ—Ä: ${sizeInBytes} –±–∞–π—Ç, Base64: ${payloadBase64.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                
            } catch (error) {
                payloadStatus.textContent = '‚ùå –û—à–∏–±–∫–∞';
                payloadStatus.className = 'text-red-400';
                addDebugLog(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                showTransactionStatus('error', '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è payload', error.message);
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –ë–õ–û–ö–ß–ï–ô–ù–ê ---

        async function getBlockchainTime() {
            blockchainResult.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            blockchainResult.className = 'text-yellow-400';
            
            try {
                addDebugLog('–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫—á–µ–π–Ω–∞ —Å API –∫–ª—é—á–æ–º...');
                
                const response = await fetch(`https://testnet.toncenter.com/api/v2/getMasterchainInfo?api_key=${API_KEY}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (!data.ok || !data.result?.last) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç API');
                
                const seqno = data.result.last.seqno;
                addDebugLog(`–ü–æ–ª—É—á–µ–Ω seqno: ${seqno}`);
                
                const blockResponse = await fetch(
                    `https://testnet.toncenter.com/api/v2/getBlockHeader?workchain=-1&shard=-9223372036854775808&seqno=${seqno}&api_key=${API_KEY}`
                );
                
                if (!blockResponse.ok) throw new Error(`Block HTTP ${blockResponse.status}`);
                
                const blockData = await blockResponse.json();
                if (!blockData.ok || !blockData.result?.gen_utime) throw new Error('gen_utime –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                reliableBlockchainTime = blockData.result.gen_utime;
                blockchainResult.textContent = '‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                blockchainResult.className = 'text-green-400';
                addDebugLog(`–í—Ä–µ–º—è –±–ª–æ–∫—á–µ–π–Ω–∞: ${new Date(reliableBlockchainTime * 1000).toLocaleString()}`, 'success');
                
            } catch (error) {
                reliableBlockchainTime = Math.floor(Date.now() / 1000);
                blockchainResult.textContent = '‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è';
                blockchainResult.className = 'text-yellow-400';
                addDebugLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫—á–µ–π–Ω–∞: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect UI
        async function initializeTonConnect() {
            try {
                addDebugLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect UI...');
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: MANIFEST_URL,
                    buttonRootId: 'wallet-connect-button'
                });

                tonConnectUI.uiOptions = {
                    actionsConfiguration: {
                        modals: ['before', 'success', 'error'],
                        notifications: ['before', 'success', 'error'],
                        returnStrategy: 'back'
                    }
                };

                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        connectionResult.textContent = `‚úÖ ${wallet.device.appName}`;
                        connectionResult.className = 'text-green-400';
                        
                        addDebugLog(`–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${wallet.device.appName}`, 'success');
                        addDebugLog(`–ê–¥—Ä–µ—Å: ${wallet.account.address}`);
                        addDebugLog(`–°–µ—Ç—å: ${wallet.account.chain}`);
                        
                        if (wallet.account.chain !== '-3') {
                            addDebugLog('–í–ù–ò–ú–ê–ù–ò–ï: –∫–æ—à–µ–ª–µ–∫ –Ω–µ –≤ testnet!', 'error');
                            showTransactionStatus('error', '–ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å', '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –Ω–∞ Testnet');
                        }
                        
                        await updateWalletBalance();
                        
                    } else {
                        connectionResult.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                        connectionResult.className = 'text-gray-400';
                        walletBalanceCard.classList.add('hidden');
                        walletBalance = null;
                        addDebugLog('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
                    }
                });

                addDebugLog('TON Connect UI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                return true;
                
            } catch (error) {
                addDebugLog(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TON Connect: ${error.message}`, 'error');
                return false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TonWeb —Å API –∫–ª—é—á–æ–º
        function initializeTonWeb() {
            try {
                const endpoint = `https://testnet.toncenter.com/api/v2/jsonRPC?api_key=${API_KEY}`;
                tonweb = new TonWeb(new TonWeb.HttpProvider(endpoint));
                addDebugLog('TonWeb –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å API –∫–ª—é—á–æ–º', 'success');
                return true;
            } catch (error) {
                addDebugLog(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TonWeb: ${error.message}`, 'error');
                return false;
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            datePicker.value = now.toISOString().slice(0, 10);
            timePicker.value = now.toISOString().slice(11, 16);
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è NFT –ë–ï–ó –û–®–ò–ë–ö–ò 416
        async function createNFT() {
            if (!datePicker.value || !timePicker.value) {
                errorMessage.classList.remove('hidden');
                return;
            }
            errorMessage.classList.add('hidden');

            addDebugLog('=== –°–û–ó–î–ê–ù–ò–ï NFT –ë–ï–ó –û–®–ò–ë–ö–ò 416 ===');

            if (!tonConnectUI.connected) {
                showModal('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.');
                return;
            }

            if (tonConnectUI.wallet.account.chain !== '-3') {
                showModal('–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –Ω–∞ Testnet (—Å–µ—Ç—å -3).');
                return;
            }

            if (!reliableBlockchainTime) {
                showModal('–í—Ä–µ–º—è –±–ª–æ–∫—á–µ–π–Ω–∞ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.');
                return;
            }

            if (walletBalance !== null && parseFloat(walletBalance) < 0.12) {
                showModal(`‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!\n\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${walletBalance} TON\n–¢—Ä–µ–±—É–µ—Ç—Å—è: ~0.12 TON\n\n–ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ TON —á–µ—Ä–µ–∑ @testgiver_ton_bot –≤ Telegram.`);
                return;
            }

            mintButton.disabled = true;
            mintButton.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ NFT...';
            hideTransactionStatus();

            try {
                showTransactionStatus('pending', '–°–æ–∑–¥–∞–Ω–∏–µ NFT —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º payload...', 
                    '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö');
                
                const metadataUrl = "https://ruslankuznetsov.github.io/timedate2nft/sample-metadata.json";
                const ownerAddress = tonConnectUI.wallet.account.address;
                
                // –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload
                addDebugLog('–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ payload...');
                const body = createOptimizedNFTPayload(ownerAddress, metadataUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                const bocBytes = await body.toBoc();
                const sizeInBytes = bocBytes.length;
                addDebugLog(`–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä payload: ${sizeInBytes} –±–∞–π—Ç`);
                
                if (sizeInBytes > 65535) {
                    throw new Error(`Payload —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π: ${sizeInBytes} –±–∞–π—Ç (–ª–∏–º–∏—Ç: 65535)`);
                }
                
                const payload = TonWeb.utils.bytesToBase64(bocBytes);
                addDebugLog(`Base64 payload –¥–ª–∏–Ω–∞: ${payload.length} —Å–∏–º–≤–æ–ª–æ–≤`);

                // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—É–º–º–æ–π
                const transaction = {
                    validUntil: reliableBlockchainTime + 900,
                    messages: [{
                        address: NFT_COLLECTION_ADDRESS,
                        amount: NFT_MINT_AMOUNT, // 0.12 TON
                        payload: payload
                    }]
                };

                addDebugLog('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–∫–∏ 416');
                addDebugLog(`–°—É–º–º–∞: ${TonWeb.utils.fromNano(NFT_MINT_AMOUNT)} TON`);
                addDebugLog(`–†–∞–∑–º–µ—Ä payload: ${sizeInBytes} –±–∞–π—Ç`);

                mintButton.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
                showTransactionStatus('pending', '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –∫–æ—à–µ–ª—å–∫–µ...', 
                    'Payload –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω - –æ—à–∏–±–∫–∞ 416 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!');

                const result = await tonConnectUI.sendTransaction(transaction);

                addDebugLog('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                addDebugLog(`BOC: ${result.boc.substring(0, 50)}...`);
                
                showTransactionStatus('success', 'NFT –í—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω!', 
                    '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–∫–∏ 416');
                showModal('üéâ NFT –í—Ä–µ–º–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\n–û—à–∏–±–∫–∞ 416 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—É—Ç–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ payload. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à –∫–æ—à–µ–ª–µ–∫ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                setTimeout(() => {
                    updateWalletBalance();
                }, 5000);

            } catch (error) {
                addDebugLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NFT: ${error.message}`, 'error');
                hideTransactionStatus();

                let errorMsg = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ NFT.';
                if (error.name === 'UserRejectsError') {
                    errorMsg = '–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.';
                } else if (error.message?.includes('Insufficient funds')) {
                    errorMsg = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${walletBalance} TON\n–¢—Ä–µ–±—É–µ—Ç—Å—è: ~0.12 TON`;
                } else if (error.message?.includes('timeout')) {
                    errorMsg = '–¢–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—à–µ–ª–µ–∫.';
                } else if (error.message?.includes('416')) {
                    errorMsg = '–û—à–∏–±–∫–∞ 416 –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.';
                }
                showModal(errorMsg);

            } finally {
                mintButton.disabled = false;
                mintButton.textContent = '–°–æ–∑–¥–∞—Ç—å NFT –≤ Testnet';
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        async function initialize() {
            addDebugLog('=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===');
            
            if (!initializeTonWeb()) {
                addDebugLog('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: TonWeb', 'error');
                return;
            }
            
            if (!await initializeTonConnect()) {
                addDebugLog('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: TON Connect', 'error');
                return;
            }
            
            await getBlockchainTime();
            setDefaultDateTime();
            
            addDebugLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        mintButton.addEventListener('click', createNFT);
        
        document.getElementById('refresh-balance').addEventListener('click', async () => {
            if (!tonConnectUI.connected) {
                showModal('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫');
                return;
            }
            await updateWalletBalance();
        });
        
        document.getElementById('test-payload').addEventListener('click', testPayloadSize);
        
        modalCloseButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        initialize();

    </script>
</body>
</html>
