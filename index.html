<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT –í—Ä–µ–º–µ–Ω–∏</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@latest/dist/tonweb.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ */
        #modal, #modal-content-div {
            transition: all 0.3s ease-in-out;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ */
        .transaction-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 relative">

    <div id="wallet-connect-button" class="absolute top-5 right-5 z-10"></div>

    <div class="w-full max-w-md mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white">–°–æ–∑–¥–∞—Ç—å NFT –í—Ä–µ–º–µ–Ω–∏</h1>
                <p class="text-gray-400 mt-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π NFT –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ TON.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="date-picker" class="block text-sm font-medium text-gray-300 mb-1">–î–∞—Ç–∞</label>
                    <input type="date" id="date-picker" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="time-picker" class="block text-sm font-medium text-gray-300 mb-1">–í—Ä–µ–º—è</label>
                    <input type="time" id="time-picker" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <p id="error-message" class="text-red-400 text-sm text-center hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.</p>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
            <div id="transaction-status" class="hidden transaction-status">
                <div id="status-text"></div>
                <div id="status-details" class="text-xs mt-2 opacity-80"></div>
            </div>

            <div class="mt-8">
                <button id="mint-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg disabled:opacity-60 disabled:cursor-not-allowed">
                    –°–æ–∑–¥–∞—Ç—å NFT –≤ Testnet
                </button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="modal-content-div" class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center scale-95">
            <p id="modal-text" class="text-lg"></p>
            <button id="modal-close-button" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                OK
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ruslankuznetsov.github.io/timedate2nft/tonconnect-manifest.json',
            buttonRootId: 'wallet-connect-button'
        });
        const tonweb = new TonWeb();

        // –ö–û–ù–°–¢–ê–ù–¢–´
        const NFT_COLLECTION_ADDRESS = 'EQD4QY8soH6j6O-x-bK30e-Y_p8n_e-rI2vB8l-s6asBfL0W';
        const MINT_PRICE = '100000000'; // 0.1 TON

        // DOM –≠–õ–ï–ú–ï–ù–¢–´
        const mintButton = document.getElementById('mint-button');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content-div');
        const modalText = document.getElementById('modal-text');
        const modalCloseButton = document.getElementById('modal-close-button');
        const datePicker = document.getElementById('date-picker');
        const timePicker = document.getElementById('time-picker');
        const errorMessage = document.getElementById('error-message');
        const transactionStatus = document.getElementById('transaction-status');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let reliableBlockchainTime = null;
        let currentTransactionHash = null;

        // --- –§–£–ù–ö–¶–ò–ò UI ---

        function showModal(message) {
            if (!modal || !modalContent || !modalText) return;
            modalText.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function hideModal() {
            if (!modal || !modalContent) return;
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function showTransactionStatus(status, text, details = '') {
            transactionStatus.classList.remove('hidden', 'status-pending', 'status-success', 'status-error');
            transactionStatus.classList.add(`status-${status}`);
            statusText.textContent = text;
            statusDetails.textContent = details;
        }

        function hideTransactionStatus() {
            transactionStatus.classList.add('hidden');
        }

        // --- –§–£–ù–ö–¶–ò–ò –ë–õ–û–ö–ß–ï–ô–ù–ê ---

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –†–ï–ê–õ–¨–ù–û–ì–û –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞ TON
        async function getBlockchainTime() {
            mintButton.disabled = true;
            mintButton.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º...';
            
            try {
                // –ú–µ—Ç–æ–¥ 1: TonCenter Testnet API (–æ—Å–Ω–æ–≤–Ω–æ–π)
                console.log('üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞ TON...');
                const masterchainResponse = await fetch('https://testnet.toncenter.com/api/v2/getMasterchainInfo');
                
                if (!masterchainResponse.ok) {
                    throw new Error(`TonCenter HTTP ${masterchainResponse.status}`);
                }
                
                const masterchainData = await masterchainResponse.json();
                console.log('üì° –û—Ç–≤–µ—Ç –æ—Ç TonCenter getMasterchainInfo:', masterchainData);
                
                if (masterchainData?.ok && masterchainData.result?.last) {
                    const seqno = masterchainData.result.last.seqno;
                    console.log(`üîó Seqno –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–ª–æ–∫–∞: ${seqno}`);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–µ
                    mintButton.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫–∞...';
                    const blockHeaderResponse = await fetch(
                        `https://testnet.toncenter.com/api/v2/getBlockHeader?workchain=-1&shard=-9223372036854775808&seqno=${seqno}`
                    );
                    
                    if (!blockHeaderResponse.ok) {
                        throw new Error(`Block header HTTP ${blockHeaderResponse.status}`);
                    }
                    
                    const blockHeaderData = await blockHeaderResponse.json();
                    console.log('üß± –û—Ç–≤–µ—Ç getBlockHeader:', blockHeaderData);
                    
                    if (blockHeaderData?.ok && blockHeaderData.result?.gen_utime) {
                        reliableBlockchainTime = blockHeaderData.result.gen_utime;
                        console.log('‚úÖ –í—Ä–µ–º—è –±–ª–æ–∫—á–µ–π–Ω–∞ –ø–æ–ª—É—á–µ–Ω–æ:', reliableBlockchainTime, new Date(reliableBlockchainTime * 1000));
                        
                        mintButton.disabled = false;
                        mintButton.textContent = '–°–æ–∑–¥–∞—Ç—å NFT –≤ Testnet';
                        return;
                    }
                }
                
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å gen_utime');
                
            } catch (error) {
                console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫—á–µ–π–Ω–∞:", error);
                
                // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
                reliableBlockchainTime = Math.floor(Date.now() / 1000);
                console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è:', reliableBlockchainTime);
                
                mintButton.disabled = false;
                mintButton.textContent = '–°–æ–∑–¥–∞—Ç—å NFT (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)';
                showTransactionStatus('error', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º', '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async function checkTransactionStatus(walletAddress, expectedAmount) {
            try {
                const response = await fetch(`https://testnet.tonapi.io/v2/accounts/${walletAddress}/transactions?limit=5`);
                if (!response.ok) return null;
                
                const data = await response.json();
                if (!data.transactions) return null;
                
                // –ò—â–µ–º –Ω–µ–¥–∞–≤–Ω—é—é –∏—Å—Ö–æ–¥—è—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –Ω—É–∂–Ω–æ–π —Å—É–º–º–æ–π
                const recentTx = data.transactions.find(tx => {
                    const isOutgoing = tx.account.address === walletAddress;
                    const isRecentEnough = (Date.now() / 1000) - tx.utime < 300; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
                    const hasRightAmount = tx.out_msgs?.some(msg => 
                        msg.value && parseInt(msg.value) >= parseInt(expectedAmount) * 0.9 // ¬±10% –¥–ª—è —É—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π
                    );
                    return isOutgoing && isRecentEnough && hasRightAmount;
                });
                
                return recentTx || null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', error);
                return null;
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            datePicker.value = now.toISOString().slice(0, 10);
            timePicker.value = now.toISOString().slice(11, 16);
        }

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        getBlockchainTime();
        setDefaultDateTime();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –æ–ø—Ü–∏–π –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        tonConnectUI.uiOptions = {
            actionsConfiguration: {
                modals: ['before', 'success', 'error'], // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞[4][8]
                notifications: ['before', 'success', 'error']
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
        tonConnectUI.onStatusChange(wallet => {
            console.log('–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω:', wallet);
            if (wallet) {
                console.log('‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω:', wallet.account.address);
                hideTransactionStatus();
            }
        });

        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è NFT
        mintButton.addEventListener('click', async () => {
            try {
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π
                if (!datePicker.value || !timePicker.value) {
                    errorMessage.classList.remove('hidden');
                    return;
                }
                errorMessage.classList.add('hidden');
                hideTransactionStatus();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
                if (!tonConnectUI.connected) {
                    showModal('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫.');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
                if (tonConnectUI.wallet.account.chain !== '-3') {
                    showModal('–û—à–∏–±–∫–∞: –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –Ω–∞ Testnet (—Å–µ—Ç—å -3).');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫—á–µ–π–Ω–∞
                if (!reliableBlockchainTime) {
                    showModal('–í—Ä–µ–º—è –±–ª–æ–∫—á–µ–π–Ω–∞ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.');
                    return;
                }

                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                mintButton.disabled = true;
                mintButton.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...';
                showTransactionStatus('pending', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...', '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ NFT –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö');

                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const metadataUrl = "https://ruslankuznetsov.github.io/timedate2nft/sample-metadata.json";
                const queryId = Math.floor(Date.now() / 1000) + Math.floor(Math.random() * 100000);
                
                const body = new tonweb.boc.Cell();
                body.bits.writeUint(1, 32); // op code –¥–ª—è mint
                body.bits.writeUint(queryId, 64); // query_id
                
                const ownerAddress = new TonWeb.utils.Address(tonConnectUI.wallet.account.address);
                const itemContent = new tonweb.boc.Cell();
                itemContent.bits.writeString(metadataUrl);
                
                const nftItemMessage = new tonweb.boc.Cell();
                nftItemMessage.bits.writeAddress(ownerAddress);
                nftItemMessage.refs.push(itemContent);
                
                body.refs.push(nftItemMessage);
                const payload = TonWeb.utils.bytesToBase64(await body.toBoc());

                // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º validUntil
                const transaction = {
                    validUntil: reliableBlockchainTime + 900, // 15 –º–∏–Ω—É—Ç[1][8]
                    network: '-3', // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º testnet[2]
                    messages: [{
                        address: NFT_COLLECTION_ADDRESS,
                        amount: MINT_PRICE,
                        payload: payload
                    }]
                };

                console.log('üíº –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞:', {
                    validUntil: transaction.validUntil,
                    currentTime: Math.floor(Date.now() / 1000),
                    timeLeft: transaction.validUntil - Math.floor(Date.now() / 1000),
                    network: transaction.network
                });

                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                mintButton.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
                showTransactionStatus('pending', '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –∫–æ—à–µ–ª—å–∫–µ...', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ—à–µ–ª—å–∫–∞');

                // –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏ sendTransaction
                const sendPromise = tonConnectUI.sendTransaction(transaction, {
                    modals: ['before', 'success', 'error'],
                    notifications: ['before', 'success', 'error']
                });

                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('TIMEOUT')), 60000) // 60 —Å–µ–∫—É–Ω–¥
                );

                const result = await Promise.race([sendPromise, timeoutPromise]);

                console.log('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', result);
                currentTransactionHash = result.boc;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –∏ –Ω–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                showTransactionStatus('success', '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–ª–æ–∫—á–µ–π–Ω–µ...');
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const userAddress = tonConnectUI.wallet.account.address;
                let attempts = 0;
                const maxAttempts = 20; // 2 –º–∏–Ω—É—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫

                const checkInterval = setInterval(async () => {
                    attempts++;
                    
                    const confirmedTx = await checkTransactionStatus(userAddress, MINT_PRICE);
                    
                    if (confirmedTx) {
                        clearInterval(checkInterval);
                        showTransactionStatus('success', 'NFT —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', `–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${confirmedTx.hash.slice(0, 10)}...`);
                        showModal('üéâ NFT –í—Ä–µ–º–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à –∫–æ—à–µ–ª–µ–∫.');
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        showTransactionStatus('pending', '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç');
                        showModal('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–µ—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –∫–æ—à–µ–ª—å–∫–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');
                    } else {
                        showTransactionStatus('pending', '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...', `–ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}`);
                    }
                }, 6000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 6 —Å–µ–∫—É–Ω–¥

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NFT:', error);
                hideTransactionStatus();

                let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                
                if (error.message === 'TIMEOUT') {
                    errorMessage = '–¢–∞–π–º-–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—à–µ–ª–µ–∫ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                } else if (error.name === 'UserRejectsError') {
                    errorMessage = '–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.';
                } else if (error.message?.includes('Insufficient funds')) {
                    errorMessage = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è NFT (—Ç—Ä–µ–±—É–µ—Ç—Å—è ~0.1 TON).';
                } else if (error.message?.includes('network')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                }
                
                showModal(errorMessage);
                
            } finally {
                mintButton.disabled = false;
                mintButton.textContent = '–°–æ–∑–¥–∞—Ç—å NFT –≤ Testnet';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        modalCloseButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });

    </script>
</body>
</html>
